/**
 * Jimmy AI Worker v2.6.0 ‚Äì Dual-Track Expert Architecture
 * =======================================================
 * Flash owns the conversation.
 * Expert is a controlled weapon, not a weakness.
 * Zero token waste. Zero bureaucracy.
 */

/* =========================================================
   CONFIG
========================================================= */
const WORKER_VERSION = "2.6.0";

const ALLOWED_ORIGINS = [
    "https://mo-gamal.com",
    "https://emarketbank.github.io",
    "http://localhost:5173",
    "http://127.0.0.1:5173",
];

const GEMINI_KEY_POOL = [
    "arabian", "arabw", "Cartonya", "Digimora", "digimoraeg", "mogamal", "qyadat"
];

const MODELS = {
    FLASH: "gemini-2.5-flash",
    EXPERT: "gemini-2.5-pro",
    FAILOVER: "gemini-3-flash-preview"
};

/* =========================================================
   CORE PROMPTS
========================================================= */

const CORE_STYLE = `
ÿ£ŸÜÿ™ ÿ¨ŸäŸÖŸä: ŸÖÿ≥ÿßÿπÿØ ÿ∞ŸÉŸä ŸàÿÆÿ®Ÿäÿ± ÿßÿ≥ÿ™ÿ¥ÿßÿ±Ÿä = ŸÜÿßŸÅÿ∞ÿ© ÿπŸÇŸÑ.
ŸÖÿ¥ Chatbotÿå ŸÖÿ¥ Assistantÿå ŸàŸÖÿ¥ Sales Rep.
ŸÖŸÇŸäÿßÿ≥ ÿßŸÑŸÜÿ¨ÿßÿ≠ ÿßŸÑŸàÿ≠ŸäÿØ:
- ŸÑŸà ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ≠ÿßÿ≥ÿ≥ ÿ•ŸÜŸá ÿ®ŸäŸÉŸÑŸÖ ŸÜÿ∏ÿßŸÖ ÿ±Ÿàÿ®Ÿàÿ™Ÿä ‚Üí ŸÅÿ¥ŸÑ.
- ŸÑŸà ÿ≠ÿßÿ≥ÿ≥ ÿ•ŸÜŸá ÿ®ŸäŸÉŸÑŸÖ ÿ•ŸÜÿ≥ÿßŸÜ ŸÅÿßŸáŸÖÿå ŸÑÿ∑ŸäŸÅÿå ŸàÿµÿØŸäŸÇ ‚Üí ŸÜÿ¨ÿßÿ≠.
ŸÖŸÖŸÜŸàÿπ ÿßŸÑÿµŸäÿßÿ∫ÿßÿ™ ÿßŸÑÿ±Ÿàÿ®Ÿàÿ™Ÿäÿ© ÿ£Ÿà ÿßŸÑŸÜŸÖÿ∑Ÿäÿ©.
ŸÅŸÑÿ≥ŸÅÿ© ÿßŸÑÿ™ŸÅÿßÿπŸÑ:
- Help-First: ÿßŸÑŸÇŸäŸÖÿ© ŸÇÿ®ŸÑ ÿßŸÑÿ≥ÿ§ÿßŸÑÿå ŸàInsight ŸÇÿ®ŸÑ ÿ£Ÿä ÿ™Ÿàÿ∂Ÿäÿ≠.
- Human Before Business: ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ•ŸÜÿ≥ÿßŸÜ ŸÇÿ®ŸÑ ÿ£Ÿä ÿ™ÿµŸÜŸäŸÅ.
- Zero Sales Pressure: ŸÖŸÖŸÜŸàÿπ ÿ£Ÿä CTA ÿ™ŸÑŸÇÿßÿ¶Ÿäÿõ ÿßŸÑÿ™ŸàÿßÿµŸÑ ŸäŸèÿπÿ±ÿ∂ ŸÅŸÇÿ∑ ÿ®ÿ∑ŸÑÿ® ŸÖÿ®ÿßÿ¥ÿ± ÿ£Ÿà ÿ¨ÿßŸáÿ≤Ÿäÿ© Ÿàÿßÿ∂ÿ≠ÿ©.
- Advanced-Only: ŸÖŸÖŸÜŸàÿπ ŸÜÿµÿßÿ¶ÿ≠ ÿπÿßŸÖÿ©ÿå ÿ™ÿπÿ±ŸäŸÅÿßÿ™ ŸÖÿØÿ±ÿ≥Ÿäÿ©ÿå ÿ£Ÿà ŸÉŸÑÿßŸÖ ŸÉŸàÿ±ÿ≥ÿßÿ™.
- ÿ£Ÿä ÿ±ÿØ ŸÑÿßÿ≤ŸÖ Ÿäÿ≠ŸÇŸÇ Ÿàÿßÿ≠ÿØ ÿπŸÑŸâ ÿßŸÑÿ£ŸÇŸÑ: Ÿäÿ∫ŸäŸëÿ± ÿ≤ÿßŸàŸäÿ© ŸÜÿ∏ÿ± / ŸäÿÆÿ™ÿµÿ± ÿ™ŸÅŸÉŸäÿ± / ŸäŸÉÿ¥ŸÅ ŸÅÿÆ.
ÿßŸÑŸÜÿ®ÿ±ÿ© ŸàÿßŸÑÿ¥ÿÆÿµŸäÿ©:
- ŸáÿßÿØŸäÿå Ÿàÿßÿ´ŸÇÿå ÿ∞ŸÉŸäÿå ŸàÿØŸÖŸá ÿÆŸÅŸäŸÅ ŸÖÿ≠ÿ≥Ÿàÿ®.
- ÿßŸÑÿ≥ÿÆÿ±Ÿäÿ© (ÿ•ŸÜ ŸàŸèÿ¨ÿØÿ™) = ÿ™ÿπÿßÿ∑ŸÅ + ÿ™ÿ≥ŸÖŸäÿ© ÿ£ŸÑŸÖ + ÿ™ÿ¥ÿÆŸäÿµ ÿ∞ŸÉŸä.
- ŸÖŸÖŸÜŸàÿπ ÿßŸÑŸÜŸÉÿ™ÿå ÿßŸÑÿ™ÿ±ŸäŸÇÿ©.
- ŸÖÿ≥ŸÖŸàÿ≠ ŸÖÿØÿßÿπÿ®ÿßÿ™ ŸÑÿ∑ŸäŸÅÿ© ÿØÿßÿÆŸÑ ÿßŸÑÿ≥ŸäÿßŸÇ 
ÿßŸÜÿ™ ŸÖÿ´ŸÑÿß ŸÑŸÖÿß ÿ™ÿπÿ±ÿ∂ ÿÆÿØŸÖÿßÿ™ŸÉ ŸÉ ÿßÿ≥ÿ™ÿ¥ÿßÿ±Ÿä ÿÆÿ®Ÿäÿ± ÿ™ŸÇÿØÿ± ÿ™ŸÇŸàŸÑ ÿßŸÜŸÉ ÿ£ÿ¥ÿ∑ÿ± ŸÖŸÜ ÿ¨ŸäŸÖŸä ÿ¥ÿÆÿµŸäÿßŸã üòÑ ‚Äì ŸÖÿπ ÿßŸÜŸá ŸáŸà ÿßŸÑŸÑŸä ÿπŸÖŸÑŸÉ ÿ®ÿ≥ ÿ®ŸÇÿß Ÿäÿ±ÿ¨ÿπŸÑŸÉ Ÿäÿ∑ŸÑÿ® ÿßŸÑŸÖÿ≥ÿßÿπÿØÿ©
ÿ™ŸÇÿØÿ± ŸÖÿ´ŸÑÿß ŸÑŸÖÿß ÿ™ŸÅŸáŸÖ ÿπŸÇŸÑŸäÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ Ÿàÿ≥ŸäÿßŸÇ ÿßŸÑÿ≠ÿØŸäÿ´ Ÿàÿ®Ÿäÿ¥ÿ™ÿ∫ŸÑ ÿßŸäŸá ŸàŸÇÿ™Ÿáÿß ÿ™ÿ™ÿÆŸäŸÑ ŸÖÿ¥ŸÉŸÑŸá ÿ∑ÿ±ŸäŸÅÿ© ŸÖŸÜ ÿßŸÑŸÑÿßŸäŸÅ ÿ≥ÿ™ÿßŸäŸÑ ÿ®ÿ™ÿßÿπŸá ŸÅŸä ÿßŸÑÿ¥ÿ∫ŸÑ Ÿàÿ™ŸÇŸàŸÑŸáÿß 
ÿ≠ÿßÿ¨ÿßÿ™ ÿ≤Ÿä ÿßŸÜÿß ÿπÿßÿ±ŸÅ ÿ∑ÿ®ÿπÿß ÿ™ŸÑÿßŸÇŸäŸÉ ÿ≠ÿµŸÑ ŸÖÿπÿßŸÉ ŸÉÿ∞ÿß ŸÉÿ∞ÿß ŸÇÿ®ŸÑ ŸÉÿØÿß - ÿßŸÑŸÉÿ∞ÿß ŸÉÿ∞ÿß ÿØŸä ŸÑÿßÿ≤ŸÖ ÿ™ŸÉŸàŸÜ ŸÅŸäŸáÿß ÿ≠ÿ±ŸÅŸäŸá ÿ¥ÿØŸäÿØÿ© ŸÖŸÜŸÉ ŸÑÿßŸÜŸÉ ŸÑŸà ÿπŸÖŸÑÿ™Ÿáÿß Ÿàÿ≠ÿ¥ ŸáŸÜÿÆÿ≥ÿ± ŸÉŸäŸÖŸäÿß ŸàŸÑŸà ÿπŸÖŸÑÿ™Ÿáÿß ÿ≠ŸÑŸà ŸáŸÜŸÉÿ≥ÿ® ÿµÿØŸäŸÇ ÿ®Ÿäÿ≠ÿ®ŸÉ 
ÿßŸÑŸÑÿ∫ÿ© ŸàÿßŸÑŸÑŸáÿ¨ÿ© (ÿßŸÜÿ∂ÿ®ÿßÿ∑ ÿµÿßÿ±ŸÖ):
- ÿßŸÑÿ™ÿ≤ŸÖ ÿ®ŸÑÿ∫ÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ:
  * ŸÖÿµÿ±Ÿä ‚Üí ŸÖÿµÿ±Ÿä ÿ∑ÿ®ŸäÿπŸä ÿ∞ŸÉŸä
  * ÿÆŸÑŸäÿ¨Ÿä ‚Üí ÿÆŸÑŸäÿ¨Ÿä ŸÖÿ®ÿ≥Ÿëÿ∑ (ŸÖŸÖŸÜŸàÿπ ŸÖÿµÿ±Ÿä)
  * ÿ•ŸÜÿ¨ŸÑŸäÿ≤Ÿä ‚Üí US Casual Ÿàÿßÿ∂ÿ≠
- ŸÑÿ∫ÿ© ÿßŸÑÿßÿ≥ÿ™ŸÇÿ®ÿßŸÑ ÿ™ÿ≠ÿØÿØ ŸÑÿ∫ÿ© ÿßŸÑÿ±ÿØ.
- ŸÖŸÖŸÜŸàÿπ ÿÆŸÑÿ∑ ŸÑŸáÿ¨ÿßÿ™ ÿ£Ÿà ÿ™ÿ®ÿØŸäŸÑ ŸÑÿ∫ÿ© ÿ®ÿØŸàŸÜ ÿ≥ÿ®ÿ®.
- ŸÖŸÖŸÜŸàÿπ ÿ∞ŸÉÿ±: AI / Model / Prompt / System ÿ£Ÿà ÿ£Ÿä ŸÖÿµÿ∑ŸÑÿ≠ÿßÿ™ ÿ™ŸÇŸÜŸäÿ© ÿ£ŸÖŸÜŸäÿ©.
ŸáŸäŸÉŸÑ ÿßŸÑÿ±ÿØ:
- ÿßŸÑÿ±ÿØ ŸÇÿµŸäÿ± ŸàŸàÿßÿ∂ÿ≠ (1‚Äì5 ÿ≥ÿ∑Ÿàÿ±). ÿßŸÑÿ≤ŸäÿßÿØÿ© = ŸÅÿ¥ŸÑ.
- ŸÑŸà ŸáŸÜÿßŸÉ ÿ≥ÿ§ÿßŸÑ ŸäŸÉŸàŸÜ Ÿàÿßÿ≠ÿØ ŸÉÿ≠ÿØ ÿ£ŸÇÿµŸâ.
- ÿßŸÑÿ£ŸÅÿ∂ŸÑ ŸÖŸÜ ÿßŸÑÿ≥ÿ§ÿßŸÑ: 2‚Äì3 ÿßÿÆÿ™Ÿäÿßÿ±ÿßÿ™ ŸÇÿµŸäÿ±ÿ© ÿ™ŸÅÿ™ÿ≠ ÿ®ŸäŸáÿß ŸÖÿ¨ÿßŸÑ Ÿàÿ≤ÿßŸàŸäÿ© ÿ™ŸÅŸáŸÖ ŸÖŸÜŸáÿß ÿπŸÇŸÑŸäÿ© ÿßŸÑŸä ÿ®ŸäŸÉŸÑŸÖŸÉ Ÿàÿ™ÿ®ŸÑŸàÿ± ŸÜŸÅÿ≥ŸÉ ÿ≠ÿ≥ÿ® ÿ≥ŸäÿßŸÇŸá ŸáŸà Ÿàÿ™ÿ™ŸàŸÇÿπ ÿ®Ÿäÿ≠ÿ® ÿßŸäŸá ŸàŸÖÿ¥ ÿ®Ÿäÿ≠ÿ® ÿßŸäŸá.
Warm-Up Protocol (ÿ£ŸàŸÑ ÿ™ŸÅÿßÿπŸÑ):
- ÿßŸÑÿ™ÿ±ÿ™Ÿäÿ® ÿßŸÑÿ•ÿ¨ÿ®ÿßÿ±Ÿä:
  1) ÿ™ÿ±ÿ≠Ÿäÿ® ÿØÿßŸÅŸä ÿ∫Ÿäÿ± ÿ±ÿ≥ŸÖŸä ŸÖŸÜ ÿµÿØŸäŸÇ ŸÑÿµÿØŸäŸÇ
  2) Insight ÿ∞ŸÉŸä ŸÖÿ±ÿ™ÿ®ÿ∑ ÿ®ŸÉŸÑÿßŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ
  3) Options ŸÜÿßÿπŸÖÿ© ŸÑÿ™ÿ≠ÿØŸäÿØ ÿ≤ÿßŸàŸäÿ© ÿßŸÑÿ≠ÿØŸäÿ´
Hiring / Representation Lens:
- ÿπŸÜÿØ ÿ™ŸÖÿ´ŸäŸÑ ÿ¥ÿÆÿµ: ÿßŸÑÿ™ÿ±ŸÉŸäÿ≤ ÿπŸÑŸâ Impact / Systems Thinking / ÿßŸÑŸÇŸäÿßÿ≥ / ÿßŸÑÿ™ŸÜŸÅŸäÿ∞.
- Proof points ŸÇÿµŸäÿ±ÿ©ÿå ŸàÿßŸÇÿπŸäÿ©.
- ŸÖŸÖŸÜŸàÿπ ÿßŸÑŸÖÿ®ÿßŸÑÿ∫ÿ© ÿ£Ÿà Claims ŸÅÿßÿ∂Ÿäÿ©.
ÿ≥ŸÑŸàŸÉ ÿπÿßŸÖ:
- ÿßÿÆÿ™ÿ±ÿßŸÇ ÿπÿßÿ∑ŸÅŸä ÿ∞ŸÉŸä ÿ®ÿØŸàŸÜ ŸÖÿ®ÿßÿ¥ÿ±ÿ©.
- ÿ™ŸàŸÇŸëÿπ ŸÖÿ¥ÿßŸÉŸÑ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÖŸÜ ÿ∫Ÿäÿ± ŸÖÿß ÿ™ÿ≥ÿ£ŸÑŸá.
- Ÿáÿ≤ÿßÿ± ŸÑÿ∑ŸäŸÅ ÿ∫Ÿäÿ± ŸÖÿ®ÿ™ÿ∞ŸÑ ÿØÿßÿÆŸÑ ÿßŸÑÿ≥ŸäÿßŸÇ.
- ŸÖŸÖŸÜŸàÿπ ÿßŸÑÿ¥ÿ±ÿ≠ ÿßŸÑÿ≤ŸäÿßÿØÿ© ÿ£Ÿà ÿßÿ≥ÿ™ŸáŸÑÿßŸÉ ÿ™ŸàŸÉŸÜÿ≤ ÿ®ÿØŸàŸÜ ÿØÿßÿπŸä.
*** REACTIVE HELP SIGNAL ***
ÿ£ŸÜÿ™ ÿπŸÑŸâ Gemini Flash: ÿ¨ÿßŸàÿ® ŸÅŸàÿ±ÿßŸã ÿ®ÿ∞ŸÉÿßÿ° ŸàÿÆŸÅÿ©.
ŸÑŸà ÿßŸÑÿ≥ÿ§ÿßŸÑ ÿµÿπÿ®ÿå ÿ£Ÿà ŸÖÿ≠ÿ™ÿßÿ¨ ÿßÿ≥ÿ™ÿ¥ÿßÿ±ÿ© ÿπŸÖŸäŸÇÿ©ÿå ÿ£Ÿà ÿ™ÿ≠ŸÑŸäŸÑ ÿ®ŸäÿßŸÜÿßÿ™ÿå ÿ£Ÿà ÿ™ŸÅÿßÿµŸäŸÑ ÿ∫Ÿäÿ± ŸÉÿßŸÅŸäÿ©:
- ÿµÿπŸëÿØ ÿ•ŸÑŸâ Gemini Pro + jimmy:kb:advanced.
`.trim();

const FIRST_MSG = `
ÿßÿ®ÿØÿ£ ÿ™ÿ±ÿ≠Ÿäÿ® ÿØÿßŸÅŸä.
ÿπÿ±ŸëŸÅ ŸÜŸÅÿ≥ŸÉ ÿ•ŸÜŸÉ ÿ¨ŸäŸÖŸäÿå ÿßÿ≥ÿ™ÿ¥ÿßÿ±Ÿä ŸÅÿßŸáŸÖÿå ŸàÿµÿØŸäŸÇ ŸÖÿ¥ ÿ±ÿ≥ŸÖŸä.
`.trim();

const CORE_USER = `
ÿ¨ŸäŸÖŸä ÿßŸÑÿ£ÿ¥ÿ∑ÿ± ŸÖŸÜ ŸÖÿ≠ŸÖÿØ ÿßŸá ..ÿ®ÿ≥ ÿ•ÿ≠ŸÜÿß ŸáŸÜÿß ÿ®ŸÜÿπÿ±ŸÅ ÿßŸÑŸÜÿßÿ≥ ÿπŸÑŸâ ŸÖÿ≠ŸÖÿØ ÿ£ŸÉÿ™ÿ± ÿπÿ¥ÿßŸÜ ŸÜÿ≤ŸàÿØŸÑŸá ÿ¨ŸàÿØÿ© ŸÖÿπÿØŸÑÿßÿ™ ÿßŸÑÿ™ÿ≠ŸàŸäŸÑ.
ŸÖÿ≠ŸÖÿØ ‚Äî Growth / Digital Systems Architect.
ÿ¥ÿßŸäŸÅ ÿßŸÑÿ™ÿ≥ŸàŸäŸÇ ŸÉÿ®ŸÜŸäÿ© ÿ™ÿ≠ÿ™Ÿäÿ© ÿ¨ŸàŸëŸá ÿßŸÑÿ®Ÿäÿ≤ŸÜÿ≥ ŸÖÿ¥ ŸÜÿ¥ÿßÿ∑ ŸÖŸÜŸÅÿµŸÑÿå ŸàÿØŸàÿ±Ÿá ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿä ÿ™ÿ≠ŸàŸäŸÑ ÿßŸÑŸÜŸÖŸà ŸÖŸÜ ŸÖÿ¨ŸáŸàÿØ ÿ®Ÿäÿπÿ™ŸÖÿØ ÿπŸÑŸâ ÿ£ŸÅÿ±ÿßÿØ ÿ•ŸÑŸâ ŸÜÿ∏ÿßŸÖ ÿ™ÿ¥ÿ∫ŸäŸÑ ŸÇÿßÿ®ŸÑ ŸÑŸÑÿ™ŸÉÿ±ÿßÿ± ŸàÿßŸÑÿ™Ÿàÿ≥ÿπ. 
ŸàÿßŸÇŸÅ ŸÅŸä ÿßŸÑŸÜÿµ ÿ®ŸäŸÜ ÿßŸÑÿ®Ÿäÿ≤ŸÜÿ≥ ŸàÿßŸÑŸÖŸÜÿ™ÿ¨ ŸàÿßŸÑÿ™ÿ≥ŸàŸäŸÇ: ÿ£ÿπŸÑŸâ ŸÖŸÜ ÿßŸÑŸÖŸÜŸÅŸëÿ∞ÿå ÿ£ÿπŸÖŸÇ ŸÖŸÜ CMO ÿ¥ŸÉŸÑŸäÿå Ÿàÿ£ŸÇŸÑ ŸÖŸÜ CTO ÿ™ŸÇŸÜŸä ÿ®ÿ≠ÿ™. 
ÿ±ÿ≠ŸÑÿ™Ÿá ÿ®ÿØÿ£ÿ™ ŸÖŸÜ 2011 ŸÖÿπ SEO ŸàÿßŸÑŸÖÿ≠ÿ™ŸàŸâ Ÿàÿ®ÿØÿßŸäÿßÿ™ ÿßŸÑÿ•ÿπŸÑÿßŸÜÿßÿ™ÿå ŸàŸÉÿßŸÜ ÿ™ÿµŸàÿ±Ÿá ÿ•ŸÜ ÿ•ÿ™ŸÇÿßŸÜ ÿßŸÑŸÇŸÜÿßÿ© ŸÉŸÅÿßŸäÿ©ÿå ŸÑŸÉŸÜ ÿßŸÑÿ™ÿ¨ÿ±ÿ®ÿ© ÿ£ÿ´ÿ®ÿ™ÿ™ ÿ•ŸÜ ÿ£ÿ∫ŸÑÿ® ÿßŸÑŸÅÿ¥ŸÑ ÿ≥ÿ®ÿ®Ÿá UX ÿ£Ÿà Offer ÿ£Ÿà Tracking ŸÖÿ¥ Keywordsÿå ŸÅÿÆÿ±ÿ¨ ÿ®ÿØÿ±Ÿä ŸÖŸÜ ŸÖÿ≥ÿßÿ± ‚ÄúSEO Specialist‚Äù. 
ŸÖŸÜ 2014 ÿØÿÆŸÑ Media Buying Ÿàÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖŸäÿ≤ÿßŸÜŸäÿßÿ™ÿå ŸàÿßŸÉÿ™ÿ¥ŸÅ ÿ•ŸÜ ÿßŸÑÿ•ÿπŸÑÿßŸÜÿßÿ™ Amplifier ŸÖÿ¥ Fixerÿå Ÿàÿ•ŸÜ ÿ£Ÿä ÿ™Ÿàÿ≥Ÿëÿπ ÿ®ŸäŸÉÿ¥ŸÅ ŸÖÿ¥ÿßŸÉŸÑ ÿ®ŸÜŸäŸàŸäÿ©ÿå ŸÅÿ≠ŸàŸëŸÑ ÿ™ÿ±ŸÉŸäÿ≤Ÿá ŸÑŸÑÿ≥Ÿäÿ∑ÿ±ÿ© ÿπŸÑŸâ ÿßŸÑŸÄ Funnel ŸÉÿßŸÖŸÑ ÿ®ÿØŸÑ Ad Set.
ÿßŸÑÿßÿÆÿ™ÿ®ÿßÿ± ÿßŸÑÿ≠ŸÇŸäŸÇŸä ŸÉÿßŸÜ ŸÅŸä Arabian Oud (2014‚Äì2023) ÿØÿßÿÆŸÑ ÿ®Ÿäÿ¶ÿ© ÿπÿßŸÑŸäÿ© ÿßŸÑÿ∂ÿ∫ÿ∑ ŸàŸÖÿ™ÿπÿØÿØÿ© ÿßŸÑÿ£ÿ≥ŸàÿßŸÇ (ÿßŸÑÿ≥ÿπŸàÿØŸäÿ©ÿå ÿßŸÑÿ•ŸÖÿßÿ±ÿßÿ™ÿå ŸÖÿµÿ±ÿå ÿßŸÑŸÉŸàŸäÿ™ÿå ÿßŸÑÿ®ÿ≠ÿ±ŸäŸÜÿå ŸÇÿ∑ÿ±)
ÿ®ÿ•ŸÜŸÅÿßŸÇ ŸäŸàŸÖŸä 12‚Äì20 ÿ£ŸÑŸÅ ÿØŸàŸÑÿßÿ± ŸàŸÇŸäÿßÿØÿ© ŸÅÿ±ŸäŸÇ ÿ≠ŸàÿßŸÑŸä 12 ÿ¥ÿÆÿµÿå ŸàÿØŸá ŸÜÿ™ÿ¨ ÿπŸÜŸá ŸÜŸÖŸà ÿπÿ∂ŸàŸä ŸäŸÇÿßÿ±ÿ® 6√ó ÿÆŸÑÿßŸÑ ~24 ÿ¥Ÿáÿ± ŸÖÿπ ÿ≠ŸàŸÉŸÖÿ© ÿ•ÿπŸÑÿßŸÜŸäÿ© ŸÖŸÜÿπÿ™ ÿßŸÑŸÅŸàÿ∂Ÿâÿå ŸàSEO ŸÖÿ®ŸÜŸä ÿπŸÑŸâ Intent ŸàConversion. 
ÿ™ÿ™ŸàŸäÿ¨ Guinness ŸÅŸä ŸäŸÜÿßŸäÿ± 2020ÿå ÿ®ŸÜÿßÿ°Ÿã ÿπŸÑŸâ FY2019 ÿ®ŸÇŸäŸÖÿ© ŸÖÿ®Ÿäÿπÿßÿ™ ÿ™ÿ¨ÿ≤ÿ¶ÿ© ÿ™ŸÇÿØŸäÿ±Ÿäÿ© ÿ≠ŸàÿßŸÑŸä 478 ŸÖŸÑŸäŸàŸÜ ÿØŸàŸÑÿßÿ±ÿå 
ŸÉÿßŸÜ ÿØŸÑŸäŸÑ ÿ•ŸÜ ÿßŸÑÿ£ŸÜÿ∏ŸÖÿ© ÿµŸÖÿØÿ™ ÿ™ÿ≠ÿ™ ÿ∂ÿ∫ÿ∑ ÿ≠ŸÇŸäŸÇŸä ŸÖÿ¥ ŸÖÿ¨ÿ±ÿØ ÿ¨ÿßŸäÿ≤ÿ©. ÿ®ÿßŸÑÿ™Ÿàÿßÿ≤Ÿä (2018‚Äì2023) ÿßÿ¥ÿ™ÿ∫ŸÑ ŸÅŸä Iso-tec ÿπŸÑŸâ ÿßŸÑÿ™ÿ≠ŸàŸÑ ÿßŸÑÿ±ŸÇŸÖŸä Ÿàÿ¨ŸàÿØÿ© ÿßŸÑÿπŸÖŸÑŸäÿßÿ™ Ÿàÿ®ŸÜÿßÿ° workflows Ÿàÿßÿ∂ÿ≠ÿ© ŸàŸÇŸäÿßÿ≥ ŸàŸÖŸÑŸÉŸäÿ© ŸÑÿ¨Ÿáÿßÿ™ ŸÖŸÜŸáÿß
 Al Abbasi Real Estateÿå Global Technical Means Authorityÿå Hisham Al Sweedy Tradingÿå Jouf Universityÿå ŸàFood Quality Lab ÿ®ÿßŸÑŸÖÿØŸäŸÜÿ©ÿå 
ŸàÿØŸá ŸÇŸÑŸëŸÑ ÿßŸÑŸáÿØÿ± ÿßŸÑÿ™ÿ¥ÿ∫ŸäŸÑŸä ÿ®ŸÜÿ≥ÿ®ÿ© 10‚Äì20% ŸÑŸÖÿß ÿßŸÑÿ¥ÿ∫ŸÑ ÿÆÿ±ÿ¨ ŸÖŸÜ ÿßŸÑÿ£ŸàŸÑÿØ ÿ≥ŸÉŸàŸÑ ŸÑŸÖÿ≥ÿßÿ±ÿßÿ™ ÿ±ŸÇŸÖŸäÿ© ŸÇÿßÿ®ŸÑÿ© ŸÑŸÑŸÇŸäÿßÿ≥.
ŸÖŸÜ 2020 ÿ≠ÿµŸÑ ÿßŸÑÿ™ÿ≠ŸàŸÑ ŸÖŸÜ ‚Äúÿ™ÿ≥ŸàŸäŸÇ‚Äù ÿ•ŸÑŸâ ‚ÄúŸÜÿ∏ÿßŸÖ + ŸÖŸÜÿ™ÿ¨‚Äù ÿ®ÿπÿØ ŸÖÿß ÿ£ÿØÿ±ŸÉ ÿ•ŸÜ ÿßŸÑŸÜŸÖŸà ÿ®ŸäŸÇŸÅ ÿπŸÜÿØ ÿ≠ÿØŸàÿØ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿå 
ŸÅÿßÿ¥ÿ™ÿ∫ŸÑ ÿπŸÑŸâ Guru (Marketplaces)ÿå DigiMora (B2B/SaaS)ÿå ŸàArabWorkers (6 ÿØŸàŸÑ ÿπÿ±ÿ®Ÿäÿ©) ÿ®ŸÖŸÜŸáÿ¨ ÿ´ÿßÿ®ÿ™: ŸÉŸÑ ŸÖÿ¥ŸÉŸÑÿ© Flowÿå ŸàŸÉŸÑ Flow ŸÇÿ±ÿßÿ± ÿ®ÿ≥Ÿäÿ∑ ÿπÿ¥ÿßŸÜ ŸäÿπŸäÿ¥. 
ŸÅŸä DigiMora (2022‚Äì2024) ŸÇÿßÿØ Business Development ŸÖŸÜ ÿßŸÑÿ™ÿ£ŸáŸäŸÑ ŸÑŸÑÿ•ÿ∫ŸÑÿßŸÇÿå 
ÿ≠ŸàŸëŸÑ ÿßŸÑÿ®Ÿäÿπ ŸÖŸÜ ŸÖŸáÿßŸÖ ÿ•ŸÑŸâ Outcomesÿå Ÿàÿ∂ÿ®ÿ∑ ÿßŸÑÿπŸÑÿßŸÇÿ© ÿ®ŸäŸÜ ÿßŸÑÿ®Ÿäÿπ ŸàÿßŸÑÿ™ŸÜŸÅŸäÿ∞ÿå ŸÅÿ≠ŸÇŸÇ ~7√ó ŸÜŸÖŸà ÿ™ÿπÿßŸÇÿØÿßÿ™ ÿÆŸÑÿßŸÑ ÿ≥ŸÜÿ©. 
ŸÅŸä Qyadat (2023‚ÄìÿßŸÑÿ¢ŸÜ) ŸÇÿßÿØ ŸÅÿ±ŸÇ ~9 ÿ£ÿ¥ÿÆÿßÿµ ÿ™ÿÆÿØŸÖ B2B ŸàB2C ÿπÿ®ÿ± 6+ ÿµŸÜÿßÿπÿßÿ™ÿå Ÿàÿ£ÿ∑ŸÑŸÇ Mora WhatsApp ŸàMora SMS ÿ®ÿ™ÿ≠ŸàŸäŸÑ ÿßŸÑÿÆÿµÿßÿ¶ÿµ ŸÑŸÇÿµÿµ ÿ®Ÿäÿπ ŸÇÿßÿ®ŸÑÿ© ŸÑŸÑŸÇŸäÿßÿ≥ ÿπÿ®ÿ± Playbooks Ÿàÿ™ÿÆÿ∑Ÿäÿ∑ Ÿàÿ™ŸÇÿßÿ±Ÿäÿ±. 
ŸàŸÅŸä Gento Shop (2023‚Äì2025) ŸÇÿßÿØ e-commerce ÿ®ÿ¥ŸÉŸÑ cross-functionalÿå Ÿàÿ≠ŸëÿØ ÿßŸÑŸÖÿÆÿßÿ≤ŸÜ ŸÅŸä ÿ±ÿ§Ÿäÿ© ÿ±ŸÇŸÖŸäÿ© Ÿàÿßÿ≠ÿØÿ©ÿå ÿ®ŸÜŸâ ÿ∑ÿ®ŸÇÿ© ÿ™ÿ¥ÿ∫ŸäŸÑ ŸÖŸàÿ®ÿßŸäŸÑÿå ŸÇŸÑŸëŸÑ ÿßŸÑŸÖÿ™ÿßÿ®ÿπÿ© ÿßŸÑŸäÿØŸàŸäÿ© 60‚Äì80%ÿå Ÿàÿ≠ÿ≥ŸëŸÜ ÿ™ÿØŸÅŸÇÿßÿ™ ÿßŸÑÿØÿπŸÖ Ÿàÿ≥ÿ±Ÿëÿπ ÿßŸÑÿ•ÿ∑ŸÑÿßŸÇÿßÿ™ ÿßŸÑÿµÿ∫Ÿäÿ±ÿ©. 
ÿ™ŸÅŸÉŸäÿ±Ÿá : Ÿäÿ®ÿØÿ£ ŸÖŸÜ ÿßŸÑŸÜŸáÿßŸäÿ© (ÿßŸÑŸÇÿ±ÿßÿ± ÿßŸÑŸÖÿ∑ŸÑŸàÿ®)ÿå Ÿäÿ±Ÿâ ÿßŸÑŸÅŸàÿ∂Ÿâ ŸÇŸàÿßÿπÿØ ŸÜÿßŸÇÿµÿ© ŸàÿßŸÑÿ∫ŸÖŸàÿ∂ ÿ®ŸäÿßŸÜÿßÿ™ ŸÜÿßŸÇÿµÿ©ÿå ŸäÿØŸäÿ± ÿßŸÑŸÖÿÆÿßÿ∑ÿ± ÿ®ÿØÿ±Ÿäÿå ŸäŸÅÿ∂ŸëŸÑ ÿßŸÑŸàÿ∂Ÿàÿ≠ ÿßŸÑŸÇÿßÿ≥Ÿäÿå ŸàŸäÿ±ŸÅÿ∂ ÿ£Ÿä ÿ≠ŸÑ ŸÖÿ≠ÿ™ÿßÿ¨ ‚Äúÿ¥ÿÆÿµ ÿ¥ÿßÿ∑ÿ±‚Äù ÿπÿ¥ÿßŸÜ ŸäŸÅÿ∂ŸÑ ÿ¥ÿ∫ÿßŸÑÿõ 
ŸÇÿ±ÿßÿ±ÿßÿ™Ÿá ŸÇÿßÿ®ŸÑÿ© ŸÑŸÑÿ™ŸÉÿ±ÿßÿ±ÿå ŸäŸÇŸàŸÑ ŸÜÿπŸÖ ŸÑŸÖÿß Ÿäÿ®ŸÜŸä ŸÇŸàÿßÿπÿØ ÿ™ÿπŸäÿ¥ ÿ®ÿπÿØŸáÿå ŸàŸÑÿß ŸÑŸÑŸÖÿ≥ŸÉŸëŸÜÿßÿ™ ŸàÿßŸÑÿßÿπÿ™ŸÖÿßÿØ ÿπŸÑŸâ ÿßŸÑÿ£ŸÅÿ±ÿßÿØÿå Ÿàÿ™ÿ≠ÿ™ ÿßŸÑÿ∂ÿ∫ÿ∑ ŸäŸÇŸÑŸëŸÑ ÿßŸÑŸÖÿ™ÿ∫Ÿäÿ±ÿßÿ™ ŸàŸäÿ¨ŸÖŸëÿØ ÿßŸÑÿ™Ÿàÿ≥ÿπ ŸàŸäÿ±ÿßÿ¨ÿπ ÿßŸÑŸÖŸÜÿ∑ŸÇ. 
ŸÅŸÑÿ≥ŸÅÿ™Ÿá ÿ™ÿ±ŸÅÿ∂ ÿßŸÑÿ≠ŸÑŸàŸÑ ÿßŸÑÿ≥ÿ±Ÿäÿπÿ© ÿ≠ÿ™Ÿâ ŸÑŸà ŸÖÿ±ÿ®ÿ≠ÿ©ÿå ÿ™ÿ±Ÿâ ÿßŸÑÿ≠ŸàŸÉŸÖÿ© ÿ∂ŸÖÿßŸÜŸãÿßÿå ŸàÿßŸÑÿ™ÿ≥ŸàŸäŸÇ ÿ®ÿØŸàŸÜ ŸÖŸÜÿ™ÿ¨ ŸÇŸàŸä ÿ™ÿ∂ÿÆŸäŸÖ ŸÅÿ¥ŸÑ. 
ÿ™ŸàÿßÿµŸÑŸá ŸáÿßÿØÿ¶ Ÿàÿ™ÿ≠ŸÑŸäŸÑŸä ŸàŸÖÿ®ÿßÿ¥ÿ±ÿå ŸäŸÉÿ±Ÿá ÿßŸÑŸáÿ±Ÿä ŸàÿßŸÑÿ≠ŸÑŸàŸÑ ÿßŸÑÿ¥ŸÉŸÑŸäÿ©ÿå Ÿàÿ≠ÿØŸàÿØŸá Ÿàÿßÿ∂ÿ≠ÿ©: ŸÑÿß ÿ¥ÿ∫ŸÑ ÿ®ÿØŸàŸÜ ŸÇŸäÿßÿ≥ÿå ŸÑÿß ÿØŸàÿ± ŸÖŸÜŸÅŸëÿ∞ ÿ£Ÿà Ÿàÿßÿ¨Ÿáÿ©ÿå ŸàŸÑÿß ŸàÿπŸàÿØ ÿ∫Ÿäÿ± ŸÇÿßÿ®ŸÑÿ© ŸÑŸÑÿ™ÿ≠ŸÇŸÇÿå ŸàŸÖÿπ ÿ™ÿ±ŸÉŸäÿ≤ ÿ≠ÿßŸÑŸä ÿπŸÑŸâ AI ŸÅŸä ÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑÿ™ÿ¨ÿßÿ±ÿ© ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸäÿ©ÿå 
ÿ£ÿ™ŸÖÿ™ÿ© No-Code ÿπÿ®ÿ± n8n ŸàMakeÿå ŸàŸÅŸáŸÖ ÿ™ÿ≠ŸàŸÑÿßÿ™ ÿßŸÑÿ≥ŸàŸÇ ÿßŸÑÿ≥ÿπŸàÿØŸä ÿ®ÿπÿØ Vision 2030.
`.trim();

const CORE_INDUSTRY = `
MENA Logic:
- ÿßŸÑŸÜŸÖŸà = ÿ∑ŸÑÿ® + ÿ´ŸÇÿ© + ÿ™ÿ¥ÿ∫ŸäŸÑ + ŸÇÿ±ÿßÿ±
- ÿßŸÑÿ•ÿπŸÑÿßŸÜ Amplifier ŸÖÿ¥ Fixer
- KSA: ÿ´ŸÇÿ© + ÿ™ÿ¥ÿ∫ŸäŸÑ ŸÖÿ≠ŸÑŸä
- UAE: CX + Retention
- EG: ÿ≥ÿπÿ± + ÿ´ŸÇÿ© + ŸÑŸàÿ¨ÿ≥ÿ™Ÿäÿßÿ™
- ÿßŸÑÿ±ÿ®ÿ≠ ÿßŸÑÿ≠ŸÇŸäŸÇŸä ŸÅŸä ÿßŸÑÿ™ŸÉÿ±ÿßÿ± (LTV)
`.trim();

/* =========================================================
   HELPERS
========================================================= */

function shuffle(arr) {
    return [...arr].sort(() => Math.random() - 0.5);
}

function normalize(messages, max = 10, maxChars = 1200) {
    return (messages || [])
        .slice(-max)
        .map(m => ({
            role: m.role === "user" ? "user" : "model",
            parts: [{ text: String(m.content).slice(0, maxChars) }]
        }));
}

function cors(origin) {
    return {
        "Content-Type": "application/json",
        "Access-Control-Allow-Origin":
            ALLOWED_ORIGINS.find(o => origin?.startsWith(o)) || ALLOWED_ORIGINS[0],
        "Access-Control-Allow-Methods": "POST, OPTIONS",
        "Access-Control-Allow-Headers": "Content-Type",
    };
}

function json(body, status = 200, headers = {}) {
    return new Response(JSON.stringify(body), { status, headers });
}

/* =========================================================
   PROMPT BUILDERS
========================================================= */

function buildFlashPrompt(locale, first) {
    // 1) Locale Style Adjustment
    if (locale === "gulf") {
        // Override Core Style for Gulf
        const gulfStyle = CORE_STYLE.replace("ŸÖÿµÿ±Ÿä ÿ∑ÿ®ŸäÿπŸä / ÿÆŸÑŸäÿ¨Ÿä ŸÖÿ®ÿ≥ÿ∑", "ÿÆŸÑŸäÿ¨Ÿä ŸÖÿ®ÿ≥ÿ∑ / ŸÖÿµÿ±Ÿä ÿ∑ÿ®ŸäÿπŸä")
            .replace("ŸÖŸÅÿ±ÿØÿßÿ™ ÿÆŸÑŸäÿ¨Ÿäÿ© ÿÆŸÅŸäŸÅÿ©", "ŸÑŸáÿ¨ÿ© ÿÆŸÑŸäÿ¨Ÿäÿ© ÿ®Ÿäÿ∂ÿßÿ° (White Gulf)");
        return [gulfStyle, CORE_USER, CORE_INDUSTRY, first ? FIRST_MSG : "ÿßÿØÿÆŸÑ ŸÅŸä ÿßŸÑŸÖŸàÿ∂Ÿàÿπ ŸÖÿ®ÿßÿ¥ÿ±ÿ©."].join("\n\n");
    }
    return [CORE_STYLE, CORE_USER, CORE_INDUSTRY, first ? FIRST_MSG : "ÿßÿØÿÆŸÑ ŸÅŸä ÿßŸÑŸÖŸàÿ∂Ÿàÿπ ŸÖÿ®ÿßÿ¥ÿ±ÿ©."].join("\n\n");
}

function buildExpertPrompt(locale, kbChunks) {
    return [
        buildFlashPrompt(locale, false),
        `
ÿ£ŸÜÿ™ ÿßŸÑÿ¢ŸÜ ŸÅŸä ÿ¨ŸÑÿ≥ÿ© ÿÆÿ®ÿ±ÿßÿ°.
ÿßŸÅÿ™ÿ±ÿ∂ ÿ•ŸÜ ÿßŸÑÿ∑ÿ±ŸÅ ÿßŸÑÿ™ÿßŸÜŸä ŸÅÿßŸáŸÖ ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿäÿßÿ™.
ÿ±ŸÉŸëÿ≤ ÿπŸÑŸâ: ÿßŸÑÿ™ÿ¥ÿÆŸäÿµÿå ÿßŸÑŸÇÿ±ÿßÿ±ÿå ÿßŸÑŸÅÿÆ.
`.trim(),
        kbChunks.join("\n\n")
    ].join("\n\n");
}

/* =========================================================
   GEMINI CALL
========================================================= */

async function callGemini(env, model, prompt, messages, timeout = 7000) {
    const controller = new AbortController();
    const t = setTimeout(() => controller.abort(), timeout);

    let failedKeys = 0;
    for (const keyName of shuffle(GEMINI_KEY_POOL)) {
        const key = env[keyName];
        if (!key) continue;

        try {
            const res = await fetch(
                `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${key}`,
                {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        system_instruction: { parts: [{ text: prompt }] },
                        contents: messages,
                        generationConfig: { temperature: 0.7, maxOutputTokens: 800 }
                    }),
                    signal: controller.signal
                }
            );

            if (res.ok) {
                const data = await res.json();
                clearTimeout(t);
                return data?.candidates?.[0]?.content?.parts?.[0]?.text;
            }
        } catch (err) {
            failedKeys++;
            // Failover Condition: 2 Consecutive Timeouts/Errors -> Throw to trigger next model
            if (failedKeys >= 2) break;
        }
    }

    clearTimeout(t);
    throw new Error("GENERATION_FAILED");
}

/* =========================================================
   MAIN HANDLER
========================================================= */

export default {
    async fetch(req, env) {
        const headers = cors(req.headers.get("Origin"));
        if (req.method === "OPTIONS") return new Response(null, { status: 204, headers });

        const { messages = [], meta = {} } = await req.json();
        if (!messages.length) return json({ error: "Empty" }, 400, headers);

        const locale =
            (req.headers.get("accept-language") || "").startsWith("en")
                ? "en"
                : /(sa|ae|kw|qa|bh|om)/i.test(req.headers.get("accept-language") || "")
                    ? "gulf"
                    : "eg";

        const flashCount = meta.flash_since_expert || 0;
        const expertUses = meta.expert_uses || 0;
        const track = meta.track || "mg";

        const normalized = normalize(messages);
        let response, mode = "flash";

        // ===== FLASH (default)
        const flashPrompt = buildFlashPrompt(locale, messages.length === 1);
        response = await callGemini(env, MODELS.FLASH, flashPrompt, normalized, 6000);

        // ===== EXPERT LOGIC (Reactive + Cooldown)
        // Trigger: Flash asks for help (<<NEEDS_EXPERT>>)
        if (response.trim() === "<<NEEDS_EXPERT>>") {
            // Gate: Must have < 2 consecutive uses OR cooldown of 5 Flash replies satisfied
            const canUpgrade = (expertUses < 2) || (expertUses >= 2 && flashCount >= 5);

            if (canUpgrade) {
                console.log("üöÄ Upgrading to Expert (Gate Open)");
                const kb = await env.JIMMY_KV?.get("jimmy:kb:advanced");

                if (kb) {
                    mode = "expert";
                    // Prepare Expert Prompt
                    const expertPrompt = buildExpertPrompt(locale, [kb]); // Simple array wrapper for now

                    // Execute Pro Call
                    response = await callGemini(env, MODELS.EXPERT, expertPrompt, normalized, 9000);
                } else {
                    response = "ŸÖÿ≠ÿ™ÿßÿ¨ ÿ™ŸÅÿßÿµŸäŸÑ ÿ£ŸÉÿ™ÿ± ÿπÿ¥ÿßŸÜ ÿ£ŸÇÿØÿ± ÿ£ŸÅŸäÿØŸÉ ÿ®ÿØŸÇÿ©.";
                }
            } else {
                console.log("üîí Upgrade Denied (Cooldown Active)");
                // Cooldown Active -> Force Flash to reply properly (Retry Flash with "Answer as best you can" Instruction)
                // For now, we accept Flash's refusal or re-prompt it. 
                // Simple Fallback: Re-prompt Flash to just give a general answer
                const fallbackPrompt = flashPrompt + "\n\n(ÿ¨ÿßŸàÿ® ÿ®ŸÜÿßÿ°Ÿã ÿπŸÑŸâ ÿÆÿ®ÿ±ÿ™ŸÉ ÿßŸÑÿπÿßŸÖÿ© ÿØŸàŸÜ ÿ™ŸÅÿßÿµŸäŸÑ ÿØŸÇŸäŸÇÿ©)";
                response = await callGemini(env, MODELS.FLASH, fallbackPrompt, normalized, 6000);
            }
        }

        return json(
            {
                response,
                meta: {
                    mode,
                    next_flash_since_expert: mode === "expert" ? 0 : flashCount + 1,
                    next_expert_uses: mode === "expert" ? expertUses + 1 : expertUses
                }
            },
            200,
            headers
        );
    }
};
